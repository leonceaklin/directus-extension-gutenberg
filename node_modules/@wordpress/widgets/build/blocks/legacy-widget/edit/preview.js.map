{"version":3,"sources":["@wordpress/widgets/src/blocks/legacy-widget/edit/preview.js"],"names":["Preview","idBase","instance","isVisible","isLoaded","setIsLoaded","srcDoc","setSrcDoc","abortController","window","AbortController","undefined","fetchPreviewHTML","restRoute","path","method","signal","data","then","response","preview","catch","error","name","abort","ref","iframe","setHeight","height","Math","max","contentDocument","documentElement","offsetHeight","body","style","IntersectionObserver","ownerDocument","defaultView","intersectionObserver","entry","isIntersecting","threshold","observe","addEventListener","disconnect","removeEventListener","event","target","overflow"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport classnames from 'classnames';\n\n/**\n * WordPress dependencies\n */\nimport { useRefEffect } from '@wordpress/compose';\nimport { useEffect, useState } from '@wordpress/element';\nimport { Disabled, Placeholder, Spinner } from '@wordpress/components';\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '@wordpress/api-fetch';\n\nexport default function Preview( { idBase, instance, isVisible } ) {\n\tconst [ isLoaded, setIsLoaded ] = useState( false );\n\tconst [ srcDoc, setSrcDoc ] = useState( '' );\n\n\tuseEffect( () => {\n\t\tconst abortController =\n\t\t\ttypeof window.AbortController === 'undefined'\n\t\t\t\t? undefined\n\t\t\t\t: new window.AbortController();\n\n\t\tasync function fetchPreviewHTML() {\n\t\t\tconst restRoute = `/wp/v2/widget-types/${ idBase }/render`;\n\t\t\treturn await apiFetch( {\n\t\t\t\tpath: restRoute,\n\t\t\t\tmethod: 'POST',\n\t\t\t\tsignal: abortController?.signal,\n\t\t\t\tdata: instance ? { instance } : {},\n\t\t\t} );\n\t\t}\n\n\t\tfetchPreviewHTML()\n\t\t\t.then( ( response ) => {\n\t\t\t\tsetSrcDoc( response.preview );\n\t\t\t} )\n\t\t\t.catch( ( error ) => {\n\t\t\t\tif ( 'AbortError' === error.name ) {\n\t\t\t\t\t// We don't want to log aborted requests.\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthrow error;\n\t\t\t} );\n\n\t\treturn () => abortController?.abort();\n\t}, [ idBase, instance ] );\n\n\t// Resize the iframe on either the load event, or when the iframe becomes visible.\n\tconst ref = useRefEffect(\n\t\t( iframe ) => {\n\t\t\t// Only set height if the iframe is loaded,\n\t\t\t// or it will grow to an unexpected large height in Safari if it's hidden initially.\n\t\t\tif ( ! isLoaded ) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// If the preview frame has another origin then this won't work.\n\t\t\t// One possible solution is to add custom script to call `postMessage` in the preview frame.\n\t\t\t// Or, better yet, we migrate away from iframe.\n\t\t\tfunction setHeight() {\n\t\t\t\t// Pick the maximum of these two values to account for margin collapsing.\n\t\t\t\tconst height = Math.max(\n\t\t\t\t\tiframe.contentDocument.documentElement?.offsetHeight ?? 0,\n\t\t\t\t\tiframe.contentDocument.body?.offsetHeight ?? 0\n\t\t\t\t);\n\n\t\t\t\t// Fallback to a height of 100px if the height cannot be determined.\n\t\t\t\t// This ensures the block is still selectable. 100px should hopefully\n\t\t\t\t// be not so big that it's annoying, and not so small that nothing\n\t\t\t\t// can be seen.\n\t\t\t\tiframe.style.height = `${ height !== 0 ? height : 100 }px`;\n\t\t\t}\n\n\t\t\tconst { IntersectionObserver } = iframe.ownerDocument.defaultView;\n\n\t\t\t// Observe for intersections that might cause a change in the height of\n\t\t\t// the iframe, e.g. a Widget Area becoming expanded.\n\t\t\tconst intersectionObserver = new IntersectionObserver(\n\t\t\t\t( [ entry ] ) => {\n\t\t\t\t\tif ( entry.isIntersecting ) {\n\t\t\t\t\t\tsetHeight();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tthreshold: 1,\n\t\t\t\t}\n\t\t\t);\n\t\t\tintersectionObserver.observe( iframe );\n\n\t\t\tiframe.addEventListener( 'load', setHeight );\n\n\t\t\treturn () => {\n\t\t\t\tintersectionObserver.disconnect();\n\t\t\t\tiframe.removeEventListener( 'load', setHeight );\n\t\t\t};\n\t\t},\n\t\t[ isLoaded ]\n\t);\n\n\treturn (\n\t\t<>\n\t\t\t{ /*\n\t\t\tWhile the iframe contents are loading, we move the iframe off-screen\n\t\t\tand display a placeholder instead. This ensures that the user\n\t\t\tdoesn't see the iframe resize (which looks really janky). We have to\n\t\t\tmove the iframe off-screen instead of hiding it because web browsers\n\t\t\twill not trigger onLoad if the iframe is hidden.\n\t\t\t*/ }\n\t\t\t{ isVisible && ! isLoaded && (\n\t\t\t\t<Placeholder>\n\t\t\t\t\t<Spinner />\n\t\t\t\t</Placeholder>\n\t\t\t) }\n\t\t\t<div\n\t\t\t\tclassName={ classnames(\n\t\t\t\t\t'wp-block-legacy-widget__edit-preview',\n\t\t\t\t\t{\n\t\t\t\t\t\t'is-offscreen': ! isVisible || ! isLoaded,\n\t\t\t\t\t}\n\t\t\t\t) }\n\t\t\t>\n\t\t\t\t<Disabled>\n\t\t\t\t\t{ /*\n\t\t\t\t\tWe use an iframe so that the widget has an opportunity to\n\t\t\t\t\tload scripts and styles that it needs to run.\n\t\t\t\t\t*/ }\n\t\t\t\t\t<iframe\n\t\t\t\t\t\tref={ ref }\n\t\t\t\t\t\tclassName=\"wp-block-legacy-widget__edit-preview-iframe\"\n\t\t\t\t\t\ttabIndex=\"-1\"\n\t\t\t\t\t\ttitle={ __( 'Legacy Widget Preview' ) }\n\t\t\t\t\t\tsrcDoc={ srcDoc }\n\t\t\t\t\t\tonLoad={ ( event ) => {\n\t\t\t\t\t\t\t// To hide the scrollbars of the preview frame for some edge cases,\n\t\t\t\t\t\t\t// such as negative margins in the Gallery Legacy Widget.\n\t\t\t\t\t\t\t// It can't be scrolled anyway.\n\t\t\t\t\t\t\t// TODO: Ideally, this should be fixed in core.\n\t\t\t\t\t\t\tevent.target.contentDocument.body.style.overflow =\n\t\t\t\t\t\t\t\t'hidden';\n\n\t\t\t\t\t\t\tsetIsLoaded( true );\n\t\t\t\t\t\t} }\n\t\t\t\t\t\theight={ 100 }\n\t\t\t\t\t/>\n\t\t\t\t</Disabled>\n\t\t\t</div>\n\t\t</>\n\t);\n}\n"]}