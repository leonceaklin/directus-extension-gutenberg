{"version":3,"sources":["@wordpress/widgets/src/blocks/legacy-widget/edit/control.js"],"names":["apiFetch","debounce","__","Control","constructor","id","idBase","instance","onChangeInstance","onChangeHasPreview","onError","_instance","_hasPreview","number","lastNumber","handleFormChange","bind","handleFormSubmit","initDOM","bindEvents","loadContent","destroy","unbindEvents","element","remove","el","class","form","method","type","name","value","toString","content","window","jQuery","$","on","addEventListener","off","removeEventListener","saveWidget","innerHTML","preview","encodeWidget","hasPreview","isEmptyHTML","hash","formData","serializeForm","document","trigger","error","saveForm","event","preventDefault","tagName","attributes","createElement","attribute","Object","entries","setAttribute","Array","isArray","child","appendChild","innerText","widget","path","data","form_data","rendered_form","response","html","isEmptyNode","node","nodeType","TEXT_NODE","nodeValue","trim","ELEMENT_NODE","includes","hasChildNodes","from","childNodes","every","URLSearchParams","FormData"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport apiFetch from '@wordpress/api-fetch';\nimport { debounce } from '@wordpress/compose';\nimport { __ } from '@wordpress/i18n';\n\n/**\n * An API for creating and loading a widget control (a <div class=\"widget\">\n * element) that is compatible with most third party widget scripts. By not\n * using React for this, we ensure that we have complete contorl over the DOM\n * and do not accidentally remove any elements that a third party widget script\n * has attached an event listener to.\n *\n * @property {Element} element The control's DOM element.\n */\nexport default class Control {\n\t/**\n\t * Creates and loads a new control.\n\t *\n\t * @access public\n\t * @param {Object}   params\n\t * @param {string}   params.id\n\t * @param {string}   params.idBase\n\t * @param {Object}   params.instance\n\t * @param {Function} params.onChangeInstance\n\t * @param {Function} params.onChangeHasPreview\n\t * @param {Function} params.onError\n\t */\n\tconstructor( {\n\t\tid,\n\t\tidBase,\n\t\tinstance,\n\t\tonChangeInstance,\n\t\tonChangeHasPreview,\n\t\tonError,\n\t} ) {\n\t\tthis.id = id;\n\t\tthis.idBase = idBase;\n\t\tthis._instance = instance;\n\t\tthis._hasPreview = null;\n\t\tthis.onChangeInstance = onChangeInstance;\n\t\tthis.onChangeHasPreview = onChangeHasPreview;\n\t\tthis.onError = onError;\n\n\t\t// We can't use the real widget number as this is calculated by the\n\t\t// server and we may not ever *actually* save this widget. Instead, use\n\t\t// a fake but unique number.\n\t\tthis.number = ++lastNumber;\n\n\t\tthis.handleFormChange = debounce(\n\t\t\tthis.handleFormChange.bind( this ),\n\t\t\t200\n\t\t);\n\t\tthis.handleFormSubmit = this.handleFormSubmit.bind( this );\n\n\t\tthis.initDOM();\n\t\tthis.bindEvents();\n\t\tthis.loadContent();\n\t}\n\n\t/**\n\t * Clean up the control so that it can be garabge collected.\n\t *\n\t * @access public\n\t */\n\tdestroy() {\n\t\tthis.unbindEvents();\n\t\tthis.element.remove();\n\t\t// TODO: How do we make third party widget scripts remove their event\n\t\t// listeners?\n\t}\n\n\t/**\n\t * Creates the control's DOM structure.\n\t *\n\t * @access private\n\t */\n\tinitDOM() {\n\t\tthis.element = el( 'div', { class: 'widget open' }, [\n\t\t\tel( 'div', { class: 'widget-inside' }, [\n\t\t\t\t( this.form = el( 'form', { class: 'form', method: 'post' }, [\n\t\t\t\t\t// These hidden form inputs are what most widgets' scripts\n\t\t\t\t\t// use to access data about the widget.\n\t\t\t\t\tel( 'input', {\n\t\t\t\t\t\tclass: 'widget-id',\n\t\t\t\t\t\ttype: 'hidden',\n\t\t\t\t\t\tname: 'widget-id',\n\t\t\t\t\t\tvalue: this.id ?? `${ this.idBase }-${ this.number }`,\n\t\t\t\t\t} ),\n\t\t\t\t\tel( 'input', {\n\t\t\t\t\t\tclass: 'id_base',\n\t\t\t\t\t\ttype: 'hidden',\n\t\t\t\t\t\tname: 'id_base',\n\t\t\t\t\t\tvalue: this.idBase ?? this.id,\n\t\t\t\t\t} ),\n\t\t\t\t\tel( 'input', {\n\t\t\t\t\t\tclass: 'widget-width',\n\t\t\t\t\t\ttype: 'hidden',\n\t\t\t\t\t\tname: 'widget-width',\n\t\t\t\t\t\tvalue: '250',\n\t\t\t\t\t} ),\n\t\t\t\t\tel( 'input', {\n\t\t\t\t\t\tclass: 'widget-height',\n\t\t\t\t\t\ttype: 'hidden',\n\t\t\t\t\t\tname: 'widget-height',\n\t\t\t\t\t\tvalue: '200',\n\t\t\t\t\t} ),\n\t\t\t\t\tel( 'input', {\n\t\t\t\t\t\tclass: 'widget_number',\n\t\t\t\t\t\ttype: 'hidden',\n\t\t\t\t\t\tname: 'widget_number',\n\t\t\t\t\t\tvalue: this.idBase ? this.number.toString() : '',\n\t\t\t\t\t} ),\n\t\t\t\t\t( this.content = el( 'div', { class: 'widget-content' } ) ),\n\t\t\t\t\t// Non-multi widgets can be saved via a Save button.\n\t\t\t\t\tthis.id &&\n\t\t\t\t\t\tel(\n\t\t\t\t\t\t\t'button',\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tclass: 'button is-primary',\n\t\t\t\t\t\t\t\ttype: 'submit',\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t__( 'Save' )\n\t\t\t\t\t\t),\n\t\t\t\t] ) ),\n\t\t\t] ),\n\t\t] );\n\t}\n\n\t/**\n\t * Adds the control's event listeners.\n\t *\n\t * @access private\n\t */\n\tbindEvents() {\n\t\t// Prefer jQuery 'change' event instead of the native 'change' event\n\t\t// because many widgets use jQuery's event bus to trigger an update.\n\t\tif ( window.jQuery ) {\n\t\t\tconst { jQuery: $ } = window;\n\t\t\t$( this.form ).on( 'change', null, this.handleFormChange );\n\t\t\t$( this.form ).on( 'input', null, this.handleFormChange );\n\t\t\t$( this.form ).on( 'submit', this.handleFormSubmit );\n\t\t} else {\n\t\t\tthis.form.addEventListener( 'change', this.handleFormChange );\n\t\t\tthis.form.addEventListener( 'input', this.handleFormChange );\n\t\t\tthis.form.addEventListener( 'submit', this.handleFormSubmit );\n\t\t}\n\t}\n\n\t/**\n\t * Removes the control's event listeners.\n\t *\n\t * @access private\n\t */\n\tunbindEvents() {\n\t\tif ( window.jQuery ) {\n\t\t\tconst { jQuery: $ } = window;\n\t\t\t$( this.form ).off( 'change', null, this.handleFormChange );\n\t\t\t$( this.form ).off( 'input', null, this.handleFormChange );\n\t\t\t$( this.form ).off( 'submit', this.handleFormSubmit );\n\t\t} else {\n\t\t\tthis.form.removeEventListener( 'change', this.handleFormChange );\n\t\t\tthis.form.removeEventListener( 'input', this.handleFormChange );\n\t\t\tthis.form.removeEventListener( 'submit', this.handleFormSubmit );\n\t\t}\n\t}\n\n\t/**\n\t * Fetches the widget's form HTML from the REST API and loads it into the\n\t * control's form.\n\t *\n\t * @access private\n\t */\n\tasync loadContent() {\n\t\ttry {\n\t\t\tif ( this.id ) {\n\t\t\t\tconst { form } = await saveWidget( this.id );\n\t\t\t\tthis.content.innerHTML = form;\n\t\t\t} else if ( this.idBase ) {\n\t\t\t\tconst { form, preview } = await encodeWidget( {\n\t\t\t\t\tidBase: this.idBase,\n\t\t\t\t\tinstance: this.instance,\n\t\t\t\t\tnumber: this.number,\n\t\t\t\t} );\n\t\t\t\tthis.content.innerHTML = form;\n\t\t\t\tthis.hasPreview = ! isEmptyHTML( preview );\n\n\t\t\t\t// If we don't have an instance, perform a save right away. This\n\t\t\t\t// happens when creating a new Legacy Widget block.\n\t\t\t\tif ( ! this.instance.hash ) {\n\t\t\t\t\tconst { instance } = await encodeWidget( {\n\t\t\t\t\t\tidBase: this.idBase,\n\t\t\t\t\t\tinstance: this.instance,\n\t\t\t\t\t\tnumber: this.number,\n\t\t\t\t\t\tformData: serializeForm( this.form ),\n\t\t\t\t\t} );\n\t\t\t\t\tthis.instance = instance;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Trigger 'widget-added' when widget is ready. This event is what\n\t\t\t// widgets' scripts use to initialize, attach events, etc. The event\n\t\t\t// must be fired using jQuery's event bus as this is what widget\n\t\t\t// scripts expect. If jQuery is not loaded, do nothing - some\n\t\t\t// widgets will still work regardless.\n\t\t\tif ( window.jQuery ) {\n\t\t\t\tconst { jQuery: $ } = window;\n\t\t\t\t$( document ).trigger( 'widget-added', [ $( this.element ) ] );\n\t\t\t}\n\t\t} catch ( error ) {\n\t\t\tthis.onError( error );\n\t\t}\n\t}\n\n\t/**\n\t * Perform a save when a multi widget's form is changed. Non-multi widgets\n\t * are saved manually.\n\t *\n\t * @access private\n\t */\n\thandleFormChange() {\n\t\tif ( this.idBase ) {\n\t\t\tthis.saveForm();\n\t\t}\n\t}\n\n\t/**\n\t * Perform a save when the control's form is manually submitted.\n\t *\n\t * @access private\n\t * @param {Event} event\n\t */\n\thandleFormSubmit( event ) {\n\t\tevent.preventDefault();\n\t\tthis.saveForm();\n\t}\n\n\t/**\n\t * Serialize the control's form, send it to the REST API, and update the\n\t * instance with the encoded instance that the REST API returns.\n\t *\n\t * @access private\n\t */\n\tasync saveForm() {\n\t\tconst formData = serializeForm( this.form );\n\n\t\ttry {\n\t\t\tif ( this.id ) {\n\t\t\t\tconst { form } = await saveWidget( this.id, formData );\n\t\t\t\tthis.content.innerHTML = form;\n\n\t\t\t\tif ( window.jQuery ) {\n\t\t\t\t\tconst { jQuery: $ } = window;\n\t\t\t\t\t$( document ).trigger( 'widget-updated', [\n\t\t\t\t\t\t$( this.element ),\n\t\t\t\t\t] );\n\t\t\t\t}\n\t\t\t} else if ( this.idBase ) {\n\t\t\t\tconst { instance, preview } = await encodeWidget( {\n\t\t\t\t\tidBase: this.idBase,\n\t\t\t\t\tinstance: this.instance,\n\t\t\t\t\tnumber: this.number,\n\t\t\t\t\tformData,\n\t\t\t\t} );\n\t\t\t\tthis.instance = instance;\n\t\t\t\tthis.hasPreview = ! isEmptyHTML( preview );\n\t\t\t}\n\t\t} catch ( error ) {\n\t\t\tthis.onError( error );\n\t\t}\n\t}\n\n\t/**\n\t * The widget's instance object.\n\t *\n\t * @access private\n\t */\n\tget instance() {\n\t\treturn this._instance;\n\t}\n\n\t/**\n\t * The widget's instance object.\n\t *\n\t * @access private\n\t */\n\tset instance( instance ) {\n\t\tif ( this._instance !== instance ) {\n\t\t\tthis._instance = instance;\n\t\t\tthis.onChangeInstance( instance );\n\t\t}\n\t}\n\n\t/**\n\t * Whether or not the widget can be previewed.\n\t *\n\t * @access public\n\t */\n\tget hasPreview() {\n\t\treturn this._hasPreview;\n\t}\n\n\t/**\n\t * Whether or not the widget can be previewed.\n\t *\n\t * @access private\n\t */\n\tset hasPreview( hasPreview ) {\n\t\tif ( this._hasPreview !== hasPreview ) {\n\t\t\tthis._hasPreview = hasPreview;\n\t\t\tthis.onChangeHasPreview( hasPreview );\n\t\t}\n\t}\n}\n\nlet lastNumber = 0;\n\nfunction el( tagName, attributes = {}, content = null ) {\n\tconst element = document.createElement( tagName );\n\tfor ( const [ attribute, value ] of Object.entries( attributes ) ) {\n\t\telement.setAttribute( attribute, value );\n\t}\n\tif ( Array.isArray( content ) ) {\n\t\tfor ( const child of content ) {\n\t\t\tif ( child ) {\n\t\t\t\telement.appendChild( child );\n\t\t\t}\n\t\t}\n\t} else if ( typeof content === 'string' ) {\n\t\telement.innerText = content;\n\t}\n\treturn element;\n}\n\nasync function saveWidget( id, formData = null ) {\n\tlet widget;\n\tif ( formData ) {\n\t\twidget = await apiFetch( {\n\t\t\tpath: `/wp/v2/widgets/${ id }?context=edit`,\n\t\t\tmethod: 'PUT',\n\t\t\tdata: {\n\t\t\t\tform_data: formData,\n\t\t\t},\n\t\t} );\n\t} else {\n\t\twidget = await apiFetch( {\n\t\t\tpath: `/wp/v2/widgets/${ id }?context=edit`,\n\t\t\tmethod: 'GET',\n\t\t} );\n\t}\n\treturn { form: widget.rendered_form };\n}\n\nasync function encodeWidget( { idBase, instance, number, formData = null } ) {\n\tconst response = await apiFetch( {\n\t\tpath: `/wp/v2/widget-types/${ idBase }/encode`,\n\t\tmethod: 'POST',\n\t\tdata: {\n\t\t\tinstance,\n\t\t\tnumber,\n\t\t\tform_data: formData,\n\t\t},\n\t} );\n\treturn {\n\t\tinstance: response.instance,\n\t\tform: response.form,\n\t\tpreview: response.preview,\n\t};\n}\n\nfunction isEmptyHTML( html ) {\n\tconst element = document.createElement( 'div' );\n\telement.innerHTML = html;\n\treturn isEmptyNode( element );\n}\n\nfunction isEmptyNode( node ) {\n\tswitch ( node.nodeType ) {\n\t\tcase node.TEXT_NODE:\n\t\t\t// Text nodes are empty if it's entirely whitespace.\n\t\t\treturn node.nodeValue.trim() === '';\n\t\tcase node.ELEMENT_NODE:\n\t\t\t// Elements that are \"embedded content\" are not empty.\n\t\t\t// https://dev.w3.org/html5/spec-LC/content-models.html#embedded-content-0\n\t\t\tif (\n\t\t\t\t[\n\t\t\t\t\t'AUDIO',\n\t\t\t\t\t'CANVAS',\n\t\t\t\t\t'EMBED',\n\t\t\t\t\t'IFRAME',\n\t\t\t\t\t'IMG',\n\t\t\t\t\t'MATH',\n\t\t\t\t\t'OBJECT',\n\t\t\t\t\t'SVG',\n\t\t\t\t\t'VIDEO',\n\t\t\t\t].includes( node.tagName )\n\t\t\t) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t// Elements with no children are empty.\n\t\t\tif ( ! node.hasChildNodes() ) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\t// Elements with children are empty if all their children are empty.\n\t\t\treturn Array.from( node.childNodes ).every( isEmptyNode );\n\t\tdefault:\n\t\t\treturn true;\n\t}\n}\n\nfunction serializeForm( form ) {\n\treturn new window.URLSearchParams(\n\t\tArray.from( new window.FormData( form ) )\n\t).toString();\n}\n"]}